
@{
    ViewBag.Title = "UnApprovedBookings";
    Layout = "~/Views/Shared/_LayoutLoggedIn.cshtml";
}

<h2>UnApprovedBookings</h2>
<br />

<h3>Number of unaccepted bookings</h3>
<h2 id="numberOfUnApprovedBookings"></h2> 
<br />
<select id="dropsterUnApprovedBookings"></select>
<br />
<br />
<br />
<table id="UnApprovedBookingstable" style="border: 1px solid black;"></table>


<textarea rows="4" cols="50" id="textAreaUnApprovedBookings"> </textarea>

<button type="button" onclick="changeBookingToAcceptedFunction()">Accept Booking</button>
@section scripts{
    <script>

        $(document).ready(function () {
            var idNumber = sessionStorage.getItem('ThisUserId');
            var url = "http://localhost:55579/api/BookingModels/UsersBookings/" + idNumber;
            $.ajax({      
            //var url = "https://alltbokatwebapi.azurewebsites.net//api/BookingModels/UsersBookings/" + idNumber;
            //url: "http://localhost:55579/api/BookingModels",
            url: url,
            type: "Get",
            
            success: function (data) {
                var numberOf = 0;
                var trHTML = '';
                alert(sessionStorage.getItem('ThisUserId'));
                alert(url);
                for (var i = 0; i < data.length; i++) {
                   
                    if (data[i].Approved) {}
                    else {
                        
                        var result = data[i].CustomerName + " " + data[i].StartTime;
                        var id = data[i].Id;

                        //var numberOf = data.length;

                        document.getElementById('numberOfUnApprovedBookings').innerHTML = numberOf

                        $('#dropsterUnApprovedBookings').append($('<option>', {
                            value: id,
                            text: result

                        }));
                        numberOf += 1;
                    }


                }
            }


        });
        });

        $("#dropsterUnApprovedBookings").change(function () {
            getSelectedUnApprovedBookingFunction();
        });

        function getSelectedUnApprovedBookingFunction() {
            $.ajax({
                //var url = "https://alltbokatwebapi.azurewebsites.net//api/BookingModels/UsersBookings/" + idNumber;
                url: "http://localhost:55579/api/BookingModels",
                type: "Get",

                success: function (data) {
                    $('#textAreaUnApprovedBookings').val("");

                    var idNumber = $('#dropsterUnApprovedBookings').val();
                    
                    var trHTML = '';
                    for (var i = 0; i < data.length; i++) {
                       
                        if (data[i].Id == idNumber) {
                            //trHTML = '<tr>' + '<td>' + data[i].CustomerName + "<button id=" + "acceptBookingBtn" + "> Accept </button>" + " |  " + '</td>' + '<td>' + data[i].CustomerEmail + " |  " + '</td>' + '<td>' + data[i].StartTime + " |  " + '</td>' + '<td>' + data[i].EndTime + " |  " + '</td>' + '<td>' + data[i].Description + '</td>' + '<td>' + "<button id=" + "acceptBookingBtn" + "> Accept </button>" + '</td>' + '</tr>';
                            trHTML = data[i].CustomerName + " |  " + data[i].CustomerEmail + " |  " + data[i].StartTime + " |  " + data[i].EndTime + " |  " + data[i].Description + " |  " + data[i].Approved;
                            var result = data[i].CustomerName;
                            var id = data[i].Id;
                          
                            $('#textAreaUnApprovedBookings').append(trHTML)                      
                        }
                    }
                }
            });
        };

            function changeBookingToAcceptedFunction() {

                idNumber = $('#dropsterUnApprovedBookings').val();
                var url = "http://localhost:55579/api/BookingModels/ApproveBooking/" + idNumber;
   
                                    var reqdata = {
                                        Id: idNumber
                                    }

                                    var stringReqdata = JSON.stringify(reqdata);
                                    $.ajax({

                                        url: url,
                                        type: 'PUT',
                                        contentType: 'application/json; charset=utf-8',
                                        dataType: 'json',

                                        data: stringReqdata,

                                        success: function (data) {
                                            console.log(data);     
                                            $('#textAreaUnApprovedBookings').val("");
                                            $("#dropsterUnApprovedBookings").empty();
                                            refreashUnApprovedBookingsFunction()
                                        },
                                        error: function (msg) { alert(msg + "startfelett"); }
                                    });
            };

            function refreashUnApprovedBookingsFunction()
            {
                $.ajax({
                    //var url = "https://alltbokatwebapi.azurewebsites.net//api/BookingModels/UsersBookings/" + idNumber;
                    url: "http://localhost:55579/api/BookingModels",
                    type: "Get",
            
                    success: function (data) {
                        var numberOf = 0;
                        var trHTML = '';
                        for (var i = 0; i < data.length; i++) {
                    
                            if (data[i].Approved) {}
                            else {
                        
                                var result = data[i].CustomerName + " " + data[i].StartTime;
                                var id = data[i].Id;      

                                document.getElementById('numberOfUnApprovedBookings').innerHTML = numberOf

                                $('#dropsterUnApprovedBookings').append($('<option>', {
                                    value: id,
                                    text: result

                                }));
                                numberOf += 1;
                            }


                        }
                    }


                });
            }


            
                                                        
    </script>

}